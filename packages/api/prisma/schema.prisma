generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  PATIENT
  DOCTOR
  ADMIN
}

enum SubscriptionProvider {
  APPLE
  GOOGLE
  STRIPE
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
}

enum DoctorApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DoctorType {
  RESIDENT
  UROLOGIST
  OTHER
}

enum AuditEventType {
  LOGIN_SUCCESS
  REGISTER_SUCCESS
  DOCTOR_APP_SUBMITTED
  DOCTOR_APP_APPROVED
  DOCTOR_APP_REJECTED
}

enum FeeKind {
  COLEGIATURA
  CONGRESO
}

enum PaymentMethod {
  PAYPAL
  ZELLE
  PAGO_MOVIL
  TRANSFERENCIA
}

enum FeeStatus {
  PENDING
  PAID
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  role         Role      @default(PATIENT)
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  profile      Profile?
  doctor       Doctor?
  doctorApplication DoctorApplication?
  subscription Subscription?
  refreshTokens RefreshToken[]
  auditEvents  AuditEvent[]
  fees         Fee[]
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Profile {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  fullName  String   @map("full_name")
  avatarUrl String?  @map("avatar_url")
  bio       String?
  city      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Doctor {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  specialty String
  rating    Float    @default(0)
  yearsExp  Int      @map("years_exp") @default(0)
  verified  Boolean  @default(false)
  links     Json?    // { website?, linkedIn?, etc. }
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Event {
  id          String   @id @default(uuid())
  title       String
  description String?
  startsAt    DateTime @map("starts_at")
  imageUrl    String?  @map("image_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
}

model Subscription {
  id          String             @id @default(uuid())
  userId      String             @unique @map("user_id")
  provider    SubscriptionProvider
  status      SubscriptionStatus @default(PENDING)
  planId      String?            @map("plan_id")
  expiresAt   DateTime?          @map("expires_at")
  externalRef String?            @map("external_ref")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DoctorApplication {
  id          String                  @id @default(uuid())
  userId      String                  @unique @map("user_id")
  status      DoctorApplicationStatus @default(PENDING)
  phone       String?
  nationalId  String?                 @map("national_id")
  location    String?
  doctorType  DoctorType?             @map("doctor_type")
  specialty   String?
  subspecialty String?
  avatarUrl   String?                 @map("avatar_url")
  createdAt   DateTime                @default(now()) @map("created_at")
  updatedAt   DateTime                @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AuditEvent {
  id        String         @id @default(uuid())
  type      AuditEventType
  userId    String?        @map("user_id")
  meta      Json?
  createdAt DateTime       @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([type])
}

model Fee {
  id         String        @id @default(uuid())
  userId     String        @map("user_id")
  kind       FeeKind
  method     PaymentMethod
  status     FeeStatus     @default(PENDING)
  amountCents Int          @map("amount_cents")
  currency   String        @default("USD")
  note       String?
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([kind])
  @@index([status])
}
